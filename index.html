<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">

    <title>Program Editor</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" />
    <link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/flatly/bootstrap.min.css" rel="stylesheet" />

    <!-- jQuery daterangepicker, jQuery timepicker, & Dragula -->
    <link href="./dependencies/jquery-daterange-picker/daterangepicker.min.css" rel="stylesheet" />
    <link href="./dependencies/jquery-timepicker/jquery.timepicker.css" rel="stylesheet" />
    <link href="./dependencies/dragula/dragula.css" rel="stylesheet" />

    <!-- Styling: Custom -->
    <link href="./styles/main.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Open+Sans+Condensed:300|Raleway" rel="stylesheet" />

  </head>
  <body class="container-fluid">
    <div class="row">
      <header class="col-md-12">
        <h1 class="mainTitle">
          Program Creator/Editor
        </h1>
        <hr />
      </header>
    </div>

    <div id="setupPrompts">
      <div class="row">
        <section class="col-md-12 setupStep instructions">
          <p class="text-justify">
            Welcome to the program creator and editor for the International Association for Cryptologic Research (IACR). This tool is designed to make creating a program for your conference easier. We'll guide you through a series of questions to create the right program for you, the first of which is below.
          </p>
        </section>
      </div>

      <div class="row">
        <section id="newOrExisting" class="col-md-8 col-md-offset-2 setupStep">
          <p>
            If you've been here before, you can edit an existing program. Otherwise, start from a new one.
          </p>
          <button type="button" name="newProg" onclick="createNew();this.blur()" class="btn btn-success btn-sm">New</button>
          <button type="button" name="existingProg" onclick="editExisting();this.blur()" class="btn btn-success btn-sm">Existing</button>
        </section>
      </div>

      <div class="row">
        <section id="versionPicker" class="col-md-8 col-md-offset-2 setupStep">
          <table class="table table-bordered" id="versionList">
            <tr>
              <th>Name</th>
              <th>Owner</th>
              <th>Last modified</th>
            </tr>
          </table>
        </section>
      </div>

      <div class="row">
        <section id="templateSelector" class="col-md-8 col-md-offset-2 setupStep">
          <select id="templateSelect" class="form-control input-sm" onchange="getConfig(this.value, false)">
            <option value="" disabled selected>Select a template</option>
            <option value="./json/crypto_config.json">Crypto</option>
            <option value="./json/broken.json">Broken</option>
            <option value="./json/test.json">Test</option>
          </select>
        </section>
      </div>

      <div class="row">
        <section id="datePicker" class="col-md-8 col-md-offset-2 setupStep">
          <p>
            Choose the start and end date for your conference.
          </p>
          <label for="startdate">From
            <input type="text" id="startdate" name="startdate" />
          </label>
          <label for="enddate">to
            <input type="text" id="enddate" name="enddate" />
          </label>
        </section>
      </div>

      <div class="row">
        <section id="uploadTalks" class="col-md-8 col-md-offset-2 form-group">
          <p>
            Next, upload a JSON file of accepted papers from websubrev.
          </p>
          <label for="uploadTalksSelector" class="btn btn-sm btn-success">
            <input type="file" accept=".json" id="uploadTalksSelector" />
            Upload JSON file
          </label>
        </section>
      </div>
    </div>

    <main id="parent">
      <div class="row">
        <section class="col-md-10 instructions">
          <p>
            Instructions: Drag talks from the left column to the sessions on the right. Once you have placed all of the talks into sessions, you can export the JSON or html and edit that to suit any other requirements.
          </p>
        </section>
        <aside class="col-md-2">
          <button type="button" name="jsonDownload" onclick="downloadJSON()" id="jsonDownloadBtn" class="btn btn-block btn-success">Download JSON</button>
          <button type="button" name="saveProgram" onclick="saveProgram()" id="saveProgramBtn" class="btn btn-block btn-success">Save</button>
        </aside>
      </div>
      <div class="row">
        <div class="col-md-3">
          <h3 class="text-center editorTitles">
            Unscheduled Talks
            <label data-toggle="tooltip" title="Add a talk" data-placement="top" data-trigger="hover">
              <button type="button" name="addTalk" class="btn btn-success" id="addTalkBtn" data-toggle="modal" data-target="#addTalkBox" onclick="addCategories()">
                <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
              </button>
            </label>
          </h3>
        </div>
        <div class="col-md-9">
          <h3 class="text-center editorTitles">
            Schedule
          </h3>
        </div>
      </div>

      <article id="talksList" class="col-md-3">
        <!-- Handlebars script that renders the list of talks based on user-uploaded json file with websubrev output -->
        <script id="talks-template" type="text/x-handlebars-template">
          <!-- BUG: may have gray outline remaining after click b/c is button rather than anchor, as edit session pencil is -->
          {{#each unassigned_talks}}
            <div id="{{id}}">
              <h3 class="categoryTitle">
                {{name}}
              </h3>
              <section class="category">
                {{#each talks}}
                <div class="talk" id="{{id}}">
                  <h4 class="toAddTalkTitle">
                    {{title}}
                  </h4>
                  <div class="authorList">
                    {{#each authors}}<span class="authorName">{{this}}</span>{{/each}}
                  </div>
                </div>
                {{/each}}
              </section>
            </div>
          {{/each}}
        </script>
      </article>

      <article id="renderedProgram" class="col-md-9">
        <!-- Handlebars script, renders editable program based on the user-selected program template -->
          <script id="program-template" type="text/x-handlebars-template">
            {{#each days}}
            <div class="row">
              <div class="col-md-5">
                <hr />
                <h3 class="pageSubtitle">
                  {{date}} <label data-toggle="tooltip" title="Add a time slot" data-placement="top" data-trigger="hover">
                    <button type="button" name="addTimeslot" class="addTimeslot btn btn-success" data-toggle="modal" data-target="#addTimeslot" onclick="prepareAddTimeslotToDay({{@index}})">
                      <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
                    </button>
                  </label>
                </h3>
              </div>
            </div>
            {{#each timeslots}}
            {{#if sessions}} <!-- only render slots that have sessions -->
            <div class="row">
              <div class="col-md-2 timeSlotDiv">
                  <a data-toggle="modal" href="#editTimeslot" class="pull-right editTimeBtn" onclick="editTimeslot({{@../index}}, {{@index}})">
                    <label data-toggle="tooltip" title="Edit the time slot" data-placement="top" data-trigger="hover">
                      <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>
                    </label>
                  </a>
                <br />
                <p class="timeSlot text-center">{{starttime}}-{{endtime}}</p>
              </div>
              {{#if twosessions}}
              <div class="col-md-5">
                <div class="track1Event panel-body" id="{{sessions.0.id}}">
                  <a data-toggle="modal" href="#editSessionBox" class="pull-right" onclick="editSession({{@../index}},{{@index}},0)">
                    <label data-toggle="tooltip" title="Edit the session" data-placement="top" data-trigger="hover">
                      <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>
                    </label>
                  </a>
                  <h4 class="text-center">
                    {{sessions.0.session_title}}
                  </h4>
                  {{#if sessions.0.location.name}}
                  <p class="dualTrackDescr">
                    {{sessions.0.location.name}}
                  </p>
                  {{/if}}
                  {{#if sessions.0.moderator}}
                  <p class="dualTrackDescr">
                    {{sessions.0.moderator}}
                  </p>
                  {{/if}}
                  {{#empty sessions.0.talks}}
                  Drag talks to this session.
                  {{#each sessions.0.talks}}
                  <div class="talk" id="{{id}}">
                    <p class="talkTitle">
                      {{title}}
                    </p>
                    <p class="dualTrackDescr">
                      {{#each authors}}
                      <span class="authorName">{{this}}</span>
                      {{/each}}
                    </p>
                  </div>
                  {{/each}}
                  {{/empty}}
                </div>
              </div>
              <div class="col-md-5">
                <div class="panel-body track2Event" id="{{sessions.1.id}}">
                  <a data-toggle="modal" href="#editSessionBox" class="pull-right" onclick="editSession({{@../index}},{{@index}},1)">
                    <label data-toggle="tooltip" title="Edit the session" data-placement="top" data-trigger="hover">
                      <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>
                    </label>
                  </a>
                  <h4 class="text-center">
                    {{sessions.1.session_title}}
                  </h4>
                  {{#if sessions.1.location.name}}
                  <p class="dualTrackDescr">
                    {{sessions.1.location.name}}
                  </p>
                  {{/if}}
                  {{#if sessions.1.moderator}}
                  <p class="dualTrackDescr">
                    {{sessions.1.moderator}}
                  </p>
                  {{/if}}
                  {{#empty sessions.1.talks}}
                  Drag talks to this session.
                  {{#each sessions.1.talks}}
                  <div class="talk" id="{{id}}">
                    <p class="talkTitle">
                      {{title}}
                    </p>
                    <p class="dualTrackDescr">
                      {{#each authors}}
                      <span class="authorName">{{this}}</span>
                      {{/each}}
                    </p>
                  </div>
                  {{/each}}
                  {{/empty}}
                </div>
              </div>
              {{else}} <!-- One session -->
              <div class="col-md-10">
                <div class="panel-body mutualEvent" id="{{sessions.0.id}}">
                  <a data-toggle="modal" href="#editSessionBox" class="pull-right" onclick="editSession({{@../index}},{{@index}},0)">
                    <label data-toggle="tooltip" title="Edit the session" data-placement="top" data-trigger="hover">
                      <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>
                    </label>
                  </a>
                  <h4>
                    {{sessions.0.session_title}}
                  </h4>
                  {{#if sessions.0.location.name}}
                  <p class="eventDescr">
                    {{sessions.0.location.name}}
                  </p>
                  {{/if}}
                  {{#if sessions.0.moderator}}
                  <p class="eventDescr">
                    {{sessions.0.moderator}}
                  </p>
                  {{/if}}
                  {{#empty sessions.0.talks}}
                  Drag talks to this session.
                  {{#each sessions.0.talks}}
                  <div class="talk" id="{{id}}">
                    <p class="mutualEventTalkTitle">
                      {{title}}
                    </p>
                    <p class="eventDescr">
                      {{#each authors}}
                      <span class="authorName">{{this}}</span>
                      {{/each}}
                    </p>
                  </div>
                  {{/each}}
                  {{/empty}}
                </div>
              </div>
              {{/if}} <!-- twosessions -->
            </div>
            {{/if}} <!-- sessions -->
            {{/each}} <!-- timeslots -->
            {{/each}} <!-- days -->
          </script>
      </article>
    </main>

    <!-- Bootstrap scripts -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <!-- Handlebars templates -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.6/handlebars.js" type="text/javascript"></script>

    <!-- Dependencies (dragula, momentJS, jQuery daterangepicker, jQuery timepicker, & datepair) -->
    <script src="./dependencies/dragula/dragula.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
    <script src="./dependencies/jquery-daterange-picker/jquery.daterangepicker.min.js"></script>
    <script src="./dependencies/jquery-timepicker/jquery.timepicker.min.js"></script>
    <script src="./dependencies/datepair/jquery.datepair.min.js"></script>

    <!-- Additional/custom scripts -->
    <script src="./scripts/editor.js"></script>

    <!-- Modal for warnings and errors -->
    <aside class="modal fade" id="errorBox" role="dialog" aria-labelledby="warningTitle">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header" id="warnBoxTitle">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
            <h2 class="modal-title" id="warningTitle">
              Warning
            </h2>
          </div>
          <div class="modal-body">
            <p id="modal-message">
              Something's not quite right here.
            </p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-success btn-sm" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </aside>

    <!-- Modal for adding a new talk -->
    <aside class="modal fade" id="addTalkBox" role="dialog" aria-labelledby="addTalkTitle">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header" id="addTalkTitleDiv">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
            <h2 class="modal-title" id="addTalkTitle">
              Add a New Talk
            </h2>
          </div>
          <div class="modal-body">
            <form>
              <div class="form-group">
                <label for="newTalkTitle">
                  Talk Title
                </label>
                <input type="text" name="newTalkTitle" placeholder="New talk title" class="form-control" id="newTalkTitle" />
              </div>
              <div class="form-group">
                <label for="newTalkAuthors">
                  Talk Author(s)
                </label>
                <p id="newAuthorHelp" class="help-block">
                  Use BibTeX formatting (i.e. names are separated by and).
                </p>
                <input type="text" name="newTalkAuthor" placeholder="Author names separated by and" class="form-control" aria-describedby="newAuthorHelp" id="newTalkAuthor" />
              </div>
              <div class="form-group">
                <label for="newTalkAffiliation">
                  Affiliation
                </label>
                <p id="newAffiliationHelp" class="help-block">
                  Enter affiliations for authors, separated by semicolon. If authors share an affiliation, there is no need to enter the same institution twice.
                </p>
                <input type="text" name="newTalkAffiliation" placeholder="Author affiliation(s)" class="form-control" aria-describedby="newAffiliationHelp" id="newTalkAffiliation" />
              </div>
              <div class="form-group">
                <label for="newTalkCategory">
                  Talk Category
                </label>
                <select id="newTalkCategory" class="form-control">
                  <option value=""></option>
                </select>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default btn-sm" data-dismiss="modal">
              Cancel
            </button>
            <button type="button" class="btn btn-success btn-sm" data-dismiss="modal" onclick="addNewTalk()">
              Add Talk
            </button>
          </div>
        </div>
      </div>
    </aside>

    <!-- Modal for editing a timeslot -->
    <aside class="modal fade" id="editTimeslot" role="dialog" aria-labelledby="timeEditTitle">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header" id="timeEditTitleDiv">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
            <h2 class="modal-title" id="timeEditTitle">
              Edit Time Slot
            </h2>
          </div>
          <div class="modal-body">
            <p class="help-block">
              Note that you may only change the times subject to the times before and after the time slot you are trying to edit.
            </p>
            <br />
            <form>
              <!-- NOTE: used only for saving edited time slot to progData -->
              <input type="hidden" id="timeslotDayIndex" value="" />
              <input type="hidden" id="timeslotIndex" value="" />
              <div class="form-inline">
                <div class="form-group">
                  <label for="startTime">
                    Start time
                  </label>
                  to
                  <label for="endTime">
                    End time
                  </label>
                </div>
                <div class="form-group" id="timeDiv">
                  <input type="text" name="startTime" class="form-control time start" id="currentStartTime" autocomplete="off" />
                  to
                  <input type="text" name="endTime" class="form-control time end" id="currentEndTime" autocomplete="off" />
                </div>
                <div id="addTrackToSession">
                  <br />
                  <br />
                  <p class="help-block">
                    To split this session into two tracks, please check the box below.
                  </p>
                  <label for="numsessions">Add a track to this timeslot?</label>
                  <input type="checkbox" name="numsessions" id="makeDualSession"></input>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default btn-sm" data-dismiss="modal">
              Cancel
            </button>
            <button type="button" class="btn btn-danger btn-sm pull-left" onclick="deleteTimeslot()">
              Delete Time Slot
            </button>
            <button type="button" class="btn btn-success btn-sm" data-dismiss="modal" onclick="saveTimeslot()">
              Save Changes
            </button>
          </div>
        </div>
      </div>
    </aside>

    <!-- Modal for editing a session -->
    <aside class="modal fade" id="editSessionBox" role="dialog" aria-labelledby="editSessionTitle">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header" id="editSessionTitleDiv">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
            <h2 class="modal-title" id="editSessionTitle">
              Edit Session
            </h2>
          </div>
          <div class="modal-body">
            <form>
              <!-- NOTE: These are used to look up the session that is being edited. -->
              <input type="hidden" id="currentDayIndex" value="" />
              <input type="hidden" id="currentSlotIndex" value="" />
              <input type="hidden" id="currentSessionIndex" value="" />
              <div class="form-group">
                <label for="sessionTitle">
                  Session Title
                </label>
                <input type="text" name="sessionTitle" placeholder="Session title" class="form-control" id="currentSessionTitle" />
              </div>
              <div class="form-group">
                <div class="form-group">
                  <!-- NOTE: track picker dropdown would go here...ruled unnecssary for MVP launch -->
                </div>
                <div class="form-group">
                  <label for="currentSessionLocation">
                    Location
                  </label>
                  <input type="text" name="currentSessionLocation" placeholder="Optional session location" class="form-control" id="currentSessionLocation" />
                </div>
                <div class="form-group">
                  <label for="currentSessionModerator">
                    Moderator
                  </label>
                  <input type="text" name="currentSessionModerator" placeholder="Optional session moderator (e.g. 'Chair: Alan Turing')" class="form-control" id="currentSessionModerator" />
                </div>
              </div>
            </form>
            <p class="help-block">
              There is currently no way to edit individual talks at this time. This is a feature that is planned for inclusion in future versions.
            </p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default btn-sm" data-dismiss="modal">
              Cancel
            </button>
            <!-- TODO: delete button currently NONFUNCTIONAL -->
            <button type="button" class="btn btn-danger btn-sm pull-left" onclick="deleteSession()">
              Delete Session
            </button>
            <button type="button" class="btn btn-success btn-sm" data-dismiss="modal" onclick="saveSession()">
              Save Session
            </button>
          </div>
        </div>
      </div>
    </aside>

    <!-- Modal for adding a timeslot -->
    <aside class="modal fade" id="addTimeslot" role="dialog" aria-labelledby="addTimeslotTitle">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header" id="addTimeslotDiv">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
            <h2 class="modal-title" id="addTimeslotTitle">
              Add a Time Slot
            </h2>
          </div>
          <div class="modal-body">
            <p class="help-block">
              Timeslots are ordered by their start time but theoretically may overlap.
            </p>
            <br />
            <form>
              <input type="hidden" id="dayIndex" value="" />
              <div class="form-inline">
                <div class="form-group">
                  <label for="startTime">
                    Start time
                  </label>
                  to
                  <label for="endTime">
                    End time
                  </label>
                </div>
                <div class="form-group" id="timeslotDiv">
                  <input type="text" name="startTime" class="form-control time start" id="newStartTime" autocomplete="off" />
                  to
                  <input type="text" name="endTime" class="form-control time end" id="newEndTime" autocomplete="off" />
                </div>
                <br />
                <br />
                <label for="numtracks">Select the number of tracks.</label>
                <select name="numtracks" id="selectSessionCount">
                  <option value="1">One track</option>
                  <option value="2">Two tracks</option>
                </select><br/>
                <label for="includeTalks">Allow talks in the timeslot:</label>
                <input type="checkbox" name="includeTalks" id="includeTalks"></input>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default btn-sm" data-dismiss="modal">
              Cancel
            </button>
            <!-- TODO: save button currently NONFUNCTIONAL -->
            <button type="button" class="btn btn-success btn-sm" data-dismiss="modal" onclick="addTimeslotToDay()">
              Add time slot
            </button>
          </div>
        </div>
      </div>
    </aside>

  </body>
</html>
